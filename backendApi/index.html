<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

      #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
      #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
      #input:focus { outline: none; }
      #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages > li { padding: 0.5rem 1rem; }
      #messages > li:nth-child(odd) { background: #efefef; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <div id="online-users-container"></div>
    <header id="private-message-header"></header>
    <!-- <form id="private-message-form" action="">
      <input id="recipient-id" autocomplete="off" />
      <input id="private-message-input" autocomplete="on" /><button>Send</button>
    </form> -->
    <input type="file" id="image-input" accept="image/*"/>
    <form id="form" action="">
      <input id="input" autocomplete="on" /><button>Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      var socket = io();

      // Prompt the user to set their nickname
      const nickname = prompt('Enter your nickname:');

      // Send the nickname to the server
      socket.emit('setNickname', nickname);

      const messages = document.getElementById('messages');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const imageInput = document.getElementById('image-input');
      const onlineUsersContainer = document.getElementById('online-users-container');
      const privateMessageForm = document.getElementById('private-message-form');


      
      imageInput.addEventListener('change', (e) =>{
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageData = e.target.result;
          const fileName = file.name;
          socket.emit('sendImage', {
            imageData: imageData,
            fileName: fileName,
          });
          appendImage('You', imageData);
        };
        reader.readAsDataURL(file);
        imageInput.value = '';
      });



      socket.on('imageReceived', (data) => {
        const { nickname, imageData } = data;
        appendImage(nickname, imageData);
      });


      function appendImage(sender, imageData) {
        const imageElement = document.createElement('div');
        imageElement.classList.add('image');
        imageElement.innerHTML = `<span class="image-sender">${sender}:</span> <img src="${imageData}" />`;
        messages.appendChild(imageElement);
        messages.scrollTop = messages.scrollHeight;
      }




      form.addEventListener('submit', function(e){
        e.preventDefault();
        if (input.value) {
          socket.emit('sendMessage', input.value);
          input.value = '';
        }
      });
      
      socket.on('messageReceived', (data) => {
        const { userId, nickname, message } = data;
        const isOwnMessage = userId === socket.id;
        const messageElement = document.createElement('li');
        messageElement.classList.add('message');
        if (isOwnMessage) {
          messageElement.classList.add('own-message');
        }
        messageElement.innerHTML = isOwnMessage
          ? `<span class="message-sender">You:</span> ${message}`
          : `<span class="message-sender">${nickname}:</span> ${message}`;
        messages.appendChild(messageElement);
        window.scrollTo(0, document.body.scrollHeight);
      });

      // imageInput.addEventListener('change', (event) => {
      //   const file = event.target.files[0];
      //   const reader = new FileReader();
      //   reader.onload = function (e) {
      //     const imageData = e.target.result;
      //     const fileName = file.name;
      //     const recipientId = document.getElementById('recipient-id').value;
      //     socket.emit('sendImage', {
      //       recipientId: recipientId,
      //       imageData: imageData,
      //       fileName: fileName,
      //     });
      //     appendPrivateImage('You', imageData);
      //   };
      //   reader.readAsDataURL(file);
      // });

      // socket.on('privateImageReceived', (data) => {
      //   const { senderNickname, imageData } = data;
      //   appendPrivateImage(senderNickname, imageData);
      // });

      // function appendPrivateImage(sender, imageData) {
      //   const imageElement = document.createElement('div');
      //   imageElement.classList.add('image');
      //   imageElement.innerHTML = `<span class="image-sender">${sender}:</span> <img src="${imageData}" />`;
      //   messagesContainer.appendChild(imageElement);
      //   messagesContainer.scrollTop = messagesContainer.scrollHeight;
      // }


      // privateMessageForm.addEventListener('submit', function(e){
      //   e.preventDefault();
      //   const recipientId = document.getElementById('recipient-id').value;
      //   const message = document.getElementById('private-message-input').value.trim();
      //   if (message !== '') {
      //     socket.emit('sendMessage', {
      //       recipientId: recipientId,
      //       message: message,
      //     });
      //     document.getElementById('private-message-input').value = '';
      //     appendPrivateMessage('You', message);
      //   }
      // });

      // socket.on('privateMessageReceived', (data) => {
      //   const { senderId, senderNickname, message } = data;
      //   appendPrivateMessage(senderNickname, message);
      // });

      // function appendPrivateMessage(sender, message) {
      //   const messageElement = document.createElement('div');
      //   messageElement.classList.add('message');
      //   messageElement.innerHTML = `<span class="message-sender">${sender}:</span> ${message}`;
      //   messages.appendChild(messageElement);
      //   messages.scrollTop = messages.scrollHeight;
      // }

      // function openPrivateChat(recipientId, recipientNickname) {
      //   document.getElementById('private-message-header').innerText = `Private Chat with ${recipientNickname}`;
      //   document.getElementById('recipient-id').value = recipientId;
      //   messages.innerHTML = '';
      // }


      let typing = false;
      let timeout = null;

      form.addEventListener('input', function(e){
        if (!typing) {
          typing = true;
          socket.emit('startTyping');
        }
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          typing = false;
          socket.emit('stopTyping');
        }, 2000);
      });

      socket.on('userTyping', (nickname) => {
        if (nickname) {
          // Update UI to show user is typing
          console.log(`${nickname} is typing...`);
        } else {
          // Update UI to hide typing status
          console.log('No one is typing.');
        }
      });

      socket.on('userConnected', (data) => {
        // Handle user connected event
        const { userId, nickname } = data;
        console.log(`User ${nickname} (${userId}) connected.`);
      });

      socket.on('userDisconnected', (data) => {
        // Handle user disconnected event
        const { userId, nickname } = data;
        console.log(`User ${nickname} (${userId}) disconnected.`);
      });
      socket.on('onlineUsers', (users) => {
        onlineUsersContainer.innerHTML = '';
        users.forEach((user) => {
          const userElement = document.createElement('div');
          userElement.innerText = user.nickname;
          userElement.addEventListener('click', () => {
            openPrivateChat(user.userId, user.nickname);
          });
          onlineUsersContainer.appendChild(userElement);
        });
      });
    </script>
  </body>
</html>